services:
  engine:
    build:
      context: .
      args:
        USE_CUDA: ${USE_CUDA:-false}
    image: tft-trading-engine:prod
    gpus: all
    container_name: tft-engine
    env_file: .env
    environment:
      ENGINE_MODE: ${ENGINE_MODE:-PAPER}
      TRADING_MODE: ${TRADING_MODE:-PAPER}
      SQLITE_PATH: /app/state/tft_engine.db
      PAPER_DB_PATH: /app/state/paper_trading.db
      ENGINE_LOCK_FILE: /app/state/tft_engine.lock
      REDIS_HOST: redis
    volumes:
      - ./state:/app/state
      - ./logs:/app/logs
      - ./saved_models:/app/saved_models:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      retries: 3
    restart: on-failure
    depends_on:
      - redis

  api:
    image: tft-trading-engine:prod
    container_name: tft-api
    entrypoint:
      [
        "python",
        "-m",
        "uvicorn",
        "dashboard.api:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8000",
      ]
    env_file: .env
    environment:
      ENGINE_MODE: ${ENGINE_MODE:-PAPER}
      TRADING_MODE: ${TRADING_MODE:-PAPER}
      SQLITE_PATH: /app/state/tft_engine.db
      PAPER_DB_PATH: /app/state/paper_trading.db
      ENGINE_LOCK_FILE: /app/state/tft_engine.lock
      REDIS_HOST: redis
    volumes:
      - ./state:/app/state
      - ./logs:/app/logs
      - ./saved_models:/app/saved_models:ro
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      retries: 3
    restart: on-failure
    depends_on:
      engine:
        condition: service_healthy

  dashboard:
    image: tft-trading-engine:prod
    container_name: tft-dashboard
    entrypoint:
      [
        "python",
        "-m",
        "streamlit",
        "run",
        "dashboard/streamlit_app.py",
        "--server.port",
        "8501",
        "--server.address",
        "0.0.0.0",
      ]
    env_file: .env
    environment:
      API_BASE: http://api:8000/api
    ports:
      - "8501:8501"
    restart: on-failure
    depends_on:
      api:
        condition: service_healthy

  redis:
    image: redis:7-alpine
    container_name: tft-redis
    restart: on-failure
    volumes:
      - redis_data:/data

volumes:
  redis_data:
