name: CI + Deploy Trading Engine

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
      - 'release-*'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest

      - name: Run tests
        run: |
          pytest -v

  deploy:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Oracle via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          envs: GITHUB_SHA,GITHUB_REF_NAME,GITHUB_REF_TYPE
          script: |
            set -euo pipefail
            cd ~/tft-trading-engine-v1
            git fetch --prune --tags origin

            if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
              TARGET_REF="refs/tags/${GITHUB_REF_NAME}"
              git checkout --detach "${TARGET_REF}"
            else
              git checkout --detach "${GITHUB_SHA}"
            fi

            python3 -m venv .venv
            source .venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            python -c "from tft_engine.database.migrations import initialize_database; initialize_database()"
            sudo systemctl restart tft-engine-api || true
            sudo systemctl restart tft-engine-dashboard || true
            sudo systemctl restart tft-engine-worker || true
