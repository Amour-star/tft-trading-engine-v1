services:
  engine:
    build:
      context: .
      args:
        USE_CUDA: ${USE_CUDA:-false}
    image: tft-trading-engine:prod
    gpus: all
    container_name: tft-engine
    command: ["python", "scripts/run_engine.py"]
    env_file: .env
    environment:
      SQLITE_PATH: /app/state/tft_engine.db
      PAPER_DB_PATH: /app/state/paper_trading.db
      ENGINE_LOCK_FILE: /app/state/tft_engine.lock
      REDIS_HOST: redis
    volumes:
      - sqlite_data:/app/state
      - logs_data:/app/logs
      - ./saved_models:/app/saved_models:ro
    restart: unless-stopped
    depends_on:
      - redis

  api:
    image: tft-trading-engine:prod
    container_name: tft-api
    command:
      [
        "python",
        "-m",
        "uvicorn",
        "dashboard.api:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8000",
      ]
    env_file: .env
    environment:
      SQLITE_PATH: /app/state/tft_engine.db
      PAPER_DB_PATH: /app/state/paper_trading.db
      ENGINE_LOCK_FILE: /app/state/tft_engine.lock
      REDIS_HOST: redis
    volumes:
      - sqlite_data:/app/state
      - logs_data:/app/logs
      - ./saved_models:/app/saved_models:ro
    ports:
      - "8000:8000"
    depends_on:
      engine:
        condition: service_started

  dashboard:
    image: tft-trading-engine:prod
    container_name: tft-dashboard
    command:
      [
        "python",
        "-m",
        "streamlit",
        "run",
        "dashboard/streamlit_app.py",
        "--server.port",
        "8501",
        "--server.address",
        "0.0.0.0",
      ]
    env_file: .env
    environment:
      API_BASE: http://api:8000/api
    ports:
      - "8501:8501"
    depends_on:
      api:
        condition: service_started

  redis:
    image: redis:7-alpine
    container_name: tft-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data

volumes:
  sqlite_data:
  logs_data:
  redis_data: